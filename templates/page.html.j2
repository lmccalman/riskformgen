<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FormGen</title>
    <link rel="stylesheet" href="pico.jade.min.css" />
    <link rel="stylesheet" href="input.css" />
    <script defer src="alpine-persist.min.js"></script>
    <script defer src="alpine3.15.8.min.js"></script>
  </head>
  <body>
    <main class="container">
      <h1>FormGen</h1>

      <div
        x-data="{
          activeTab: $persist('{{ sections[0].id }}'),
          answers: $persist({
            {% for q in questions %}
            '{{ q.id }}': {% if q.type == 'multiple_select' %}[]{% else %}''{% endif %}{% if not loop.last %},{% endif %}
            {% endfor %}
          }),
          assessed_risks: $persist({
            {% for risk in risks %}'{{ risk.id }}': ''{% if not loop.last %},{% endif %}
            {% endfor %}
          }),
          justifications: $persist({
            {% for risk in risks %}'{{ risk.id }}': ''{% if not loop.last %},{% endif %}
            {% endfor %}
          }),
          _likelihoods: {{ likelihoods_js }},
          _consequences: {{ consequences_js }},
          _risk_matrix: {{ risk_matrix_js }},
          _worst(results, dim, scale) {
            const vals = results.map(r => r[dim]).filter(v => v !== null);
            if (vals.length === 0) return null;
            return vals.reduce((w, v) => scale.indexOf(v) > scale.indexOf(w) ? v : w);
          },
          _formatAnswer(val) {
            if (Array.isArray(val)) return val.length ? val.join(', ') : 'Not answered';
            return val || 'Not answered';
          },
          {% for ctrl in control_getters %}
          get ctrl_{{ ctrl.id }}() { return {{ ctrl.js }}; },
          {% endfor %}
          {% for risk in risks %}
          get {{ risk.id }}() {
            const results = [
              {% for js in risk.rules_js %}
              ({{ js }}),
              {% endfor %}
            ].filter(r => r !== null);
            const likelihood = this._worst(results, 'likelihood', this._likelihoods)
              || '{{ risk.default_likelihood }}';
            const consequence = this._worst(results, 'consequence', this._consequences)
              || '{{ risk.default_consequence }}';
            return {
              likelihood, consequence,
              level: (this._risk_matrix[likelihood] || {})[consequence] || 'not_applicable'
            };
          },
          {% endfor %}
        }"
      >
        {# ── Tab navigation ── #}
        <nav class="tabs">
          {% for section in sections %}
          <button
            type="button"
            @click="activeTab = '{{ section.id }}'"
            :class="activeTab === '{{ section.id }}' && 'active'"
          >
            {{ section.title }}
          </button>
          {% endfor %}
          <button
            type="button"
            class="tab-risk"
            @click="activeTab = 'risks'"
            :class="activeTab === 'risks' && 'active'"
          >
            Risk Analysis
          </button>
          <button
            type="button"
            class="tab-debug"
            @click="activeTab = 'debug'"
            :class="activeTab === 'debug' && 'active'"
          >
            Debug
          </button>
        </nav>

        {# ── Section tabs ── #}
        {% for section in sections %}
        <form x-show="activeTab === '{{ section.id }}'" class="stack-lg">
          <p><small>{{ section.description }}</small></p>
          {% for subsection in section.subsections %}
          {% with subsection=subsection %}
          {% include "subsection.html.j2" %}
          {% endwith %}
          {% endfor %}
        </form>
        {% endfor %}

        {# ── Debug tab ── #}
        <div x-show="activeTab === 'debug'" data-theme="dark" class="stack-md">
          <h3>Current Answers</h3>
          <pre x-text="JSON.stringify(answers, null, 2)"></pre>
          {% if risks %}
          <h3>Risk Levels</h3>
          <pre x-text="JSON.stringify({
            {% for risk in risks %}
            '{{ risk.id }}': {{ risk.id }}{% if not loop.last %},{% endif %}
            {% endfor %}
          }, null, 2)"></pre>
          <h3>Assessed Risks</h3>
          <pre x-text="JSON.stringify(assessed_risks, null, 2)"></pre>
          <h3>Justifications</h3>
          <pre x-text="JSON.stringify(justifications, null, 2)"></pre>
          {% endif %}
        </div>

        {# ── Risks tab ── #}
        <div x-show="activeTab === 'risks'" class="stack-md">
          {% if risks %}
          {% for risk in risks %}
          {% with risk=risk %}
          {% include "risk_summary.html.j2" %}
          {% endwith %}
          {% endfor %}
          {% else %}
          <p>No risks defined.</p>
          {% endif %}
        </div>
      </div>
    </main>
  </body>
</html>
