<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FormGen</title>
    <link rel="stylesheet" href="bulma.min.css" />
    <link rel="stylesheet" href="input.css" />
    <script defer src="alpine-persist.min.js"></script>
    <script defer src="alpine3.15.8.min.js"></script>
  </head>
  <body>
    <main class="container">
      <h1 class="title is-3">FormGen</h1>

      <div
        x-data="{
          activeTab: $persist('{{ sections[0].id }}'),
          answers: $persist({
            {% for q in questions %}
            '{{ q.id }}': {% if q.type == 'multiple_select' %}[]{% else %}''{% endif %}{% if not loop.last %},{% endif %}
            {% endfor %}
          }),
          assessed_risks: $persist({
            {% for risk in risks %}'{{ risk.id }}': ''{% if not loop.last %},{% endif %}
            {% endfor %}
          }),
          justifications: $persist({
            {% for risk in risks %}'{{ risk.id }}': ''{% if not loop.last %},{% endif %}
            {% endfor %}
          }),
          mandated_controls: $persist({
            {% for risk in risks %}
            '{{ risk.id }}': {
              {% for ctrl in risk.controls %}'{{ ctrl.id }}': false{% if not loop.last %},{% endif %}
              {% endfor %}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
          }),
          mandated_comments: $persist({
            {% for risk in risks %}
            '{{ risk.id }}': {
              {% for ctrl in risk.controls %}'{{ ctrl.id }}': ''{% if not loop.last %},{% endif %}
              {% endfor %}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
          }),
          _questionIds: [{% for q in questions %}'{{ q.id }}'{% if not loop.last %}, {% endif %}{% endfor %}],
          _arrayQuestionIds: [{% for q in questions %}{% if q.type == 'multiple_select' %}'{{ q.id }}', {% endif %}{% endfor %}],
          _riskIds: [{% for risk in risks %}'{{ risk.id }}'{% if not loop.last %}, {% endif %}{% endfor %}],
          _likelihoods: {{ likelihoods_js }},
          _consequences: {{ consequences_js }},
          _risk_matrix: {{ risk_matrix_js }},
          _worst(results, dim, scale) {
            const vals = results.map(r => r[dim]).filter(v => v !== null);
            if (vals.length === 0) return null;
            return vals.reduce((w, v) => scale.indexOf(v) > scale.indexOf(w) ? v : w);
          },
          _formatAnswer(val) {
            if (Array.isArray(val)) return val.length ? val.join(', ') : 'Not answered';
            return val || 'Not answered';
          },
          _downloadJson(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
          },
          exportAnswers() {
            this._downloadJson({
              format: 'riskformgen-answers',
              version: 1,
              exported_at: new Date().toISOString(),
              question_ids: this._questionIds,
              answers: this.answers,
            }, 'riskformgen-answers.json');
          },
          _importJson(event, {format, fileIdsKey, currentIds, label, count, apply}) {
            const file = event.target.files[0];
            if (!file) return;
            event.target.value = '';
            const reader = new FileReader();
            reader.onload = () => {
              let data;
              try { data = JSON.parse(reader.result); }
              catch { alert('Invalid JSON file.'); return; }
              if (data.format !== format) {
                alert(`This is not a ${label} file. Expected format: ${format}`);
                return;
              }
              const fileIds = new Set(data[fileIdsKey] || []);
              const currentIdSet = new Set(currentIds);
              const added = currentIds.filter(id => !fileIds.has(id));
              const removed = (data[fileIdsKey] || []).filter(id => !currentIdSet.has(id));
              const {loaded, skippedType = 0} = count(data, currentIds);
              const parts = [`Load ${loaded} of ${currentIds.length} ${label}?`];
              if (added.length) parts.push(`${added.length} new since export (left at defaults).`);
              if (removed.length) parts.push(`${removed.length} exported skipped (removed).`);
              if (skippedType) parts.push(`${skippedType} skipped (type mismatch).`);
              if (loaded === currentIds.length && !removed.length && !skippedType) {
                /* no mismatches — load silently */
              } else if (!confirm(parts.join(' '))) {
                return;
              }
              apply(data, currentIds);
            };
            reader.readAsText(file);
          },
          importAnswers(event) {
            const arrayIds = new Set(this._arrayQuestionIds);
            this._importJson(event, {
              format: 'riskformgen-answers',
              fileIdsKey: 'question_ids',
              currentIds: this._questionIds,
              label: 'answers',
              count: (data, ids) => {
                let loaded = 0, skippedType = 0;
                for (const id of ids) {
                  if (!(id in data.answers)) continue;
                  if (arrayIds.has(id) !== Array.isArray(data.answers[id])) { skippedType++; continue; }
                  loaded++;
                }
                return {loaded, skippedType};
              },
              apply: (data, ids) => {
                for (const id of ids) {
                  if (!(id in data.answers)) continue;
                  if (arrayIds.has(id) !== Array.isArray(data.answers[id])) continue;
                  this.answers[id] = data.answers[id];
                }
              },
            });
          },
          exportAssessment() {
            this._downloadJson({
              format: 'riskformgen-assessment',
              version: 1,
              exported_at: new Date().toISOString(),
              risk_ids: this._riskIds,
              assessed_risks: this.assessed_risks,
              justifications: this.justifications,
              mandated_controls: this.mandated_controls,
              mandated_comments: this.mandated_comments,
            }, 'riskformgen-assessment.json');
          },
          importAssessment(event) {
            this._importJson(event, {
              format: 'riskformgen-assessment',
              fileIdsKey: 'risk_ids',
              currentIds: this._riskIds,
              label: 'assessments',
              count: (data, ids) => {
                let loaded = 0;
                for (const id of ids) {
                  if (id in (data.assessed_risks || {}) || id in (data.justifications || {})) loaded++;
                }
                return {loaded};
              },
              apply: (data, ids) => {
                for (const id of ids) {
                  if (data.assessed_risks && id in data.assessed_risks) {
                    this.assessed_risks[id] = data.assessed_risks[id];
                  }
                  if (data.justifications && id in data.justifications) {
                    this.justifications[id] = data.justifications[id];
                  }
                  if (data.mandated_controls && data.mandated_controls[id]) {
                    for (const [ctrl, val] of Object.entries(data.mandated_controls[id])) {
                      if (this.mandated_controls[id] && ctrl in this.mandated_controls[id]) {
                        this.mandated_controls[id][ctrl] = val;
                      }
                    }
                  }
                  if (data.mandated_comments && data.mandated_comments[id]) {
                    for (const [ctrl, val] of Object.entries(data.mandated_comments[id])) {
                      if (this.mandated_comments[id] && ctrl in this.mandated_comments[id]) {
                        this.mandated_comments[id][ctrl] = val;
                      }
                    }
                  }
                }
              },
            });
          },
          {% for ctrl in control_getters %}
          get ctrl_{{ ctrl.id }}() { return {{ ctrl.js }}; },
          {% endfor %}
          {% for risk in risks %}
          get {{ risk.id }}() {
            const results = [
              {% for js in risk.rules_js %}
              ({{ js }}),
              {% endfor %}
            ].filter(r => r !== null);
            const likelihood = this._worst(results, 'likelihood', this._likelihoods)
              || '{{ risk.default_likelihood }}';
            const consequence = this._worst(results, 'consequence', this._consequences)
              || '{{ risk.default_consequence }}';
            return {
              likelihood, consequence,
              level: (this._risk_matrix[likelihood] || {})[consequence] || 'not_applicable'
            };
          },
          {% endfor %}
        }"
      >
        {# ── Tab navigation ── #}
        <div class="tabs is-boxed">
          <ul>
            {% for section in sections %}
            <li :class="activeTab === '{{ section.id }}' && 'is-active'">
              <a @click="activeTab = '{{ section.id }}'">{{ section.title }}</a>
            </li>
            {% endfor %}
            <li class="tab-spacer"></li>
            <li class="tab-risk" :class="activeTab === 'risks' && 'is-active'">
              <a @click="activeTab = 'risks'">Risk Analysis</a>
            </li>
            <li class="tab-debug" :class="activeTab === 'debug' && 'is-active'">
              <a @click="activeTab = 'debug'">Debug</a>
            </li>
          </ul>
        </div>

        {# ── Section tabs ── #}
        {% for section in sections %}
        <form x-show="activeTab === '{{ section.id }}'" class="stack-lg">
          <p class="has-text-grey">{{ section.description }}</p>
          {% for subsection in section.subsections %}
          {% with subsection=subsection %}
          {% include "subsection.html.j2" %}
          {% endwith %}
          {% endfor %}
        </form>
        {% endfor %}

        {# ── Answers save/load (shared across all section tabs) ── #}
        <div x-show="activeTab !== 'risks' && activeTab !== 'debug'">
          {% with export_fn="exportAnswers", import_fn="importAnswers", import_ref="answersFile", file_label="answers" %}
          {% include "save_load.html.j2" %}
          {% endwith %}
        </div>

        {# ── Debug tab ── #}
        <div x-show="activeTab === 'debug'" class="debug-panel stack-md">
          <h3 class="title is-5">Current Answers</h3>
          <pre x-text="JSON.stringify(answers, null, 2)"></pre>
          {% if risks %}
          <h3 class="title is-5">Risk Levels</h3>
          <pre x-text="JSON.stringify({
            {% for risk in risks %}
            '{{ risk.id }}': {{ risk.id }}{% if not loop.last %},{% endif %}
            {% endfor %}
          }, null, 2)"></pre>
          <h3 class="title is-5">Assessed Risks</h3>
          <pre x-text="JSON.stringify(assessed_risks, null, 2)"></pre>
          <h3 class="title is-5">Justifications</h3>
          <pre x-text="JSON.stringify(justifications, null, 2)"></pre>
          <h3 class="title is-5">Mandated Controls</h3>
          <pre x-text="JSON.stringify(mandated_controls, null, 2)"></pre>
          <h3 class="title is-5">Mandated Comments</h3>
          <pre x-text="JSON.stringify(mandated_comments, null, 2)"></pre>
          {% endif %}
        </div>

        {# ── Risks tab ── #}
        <div x-show="activeTab === 'risks'" class="stack-md">
          {% if risks %}
          {% for risk in risks %}
          {% with risk=risk %}
          {% include "risk_summary.html.j2" %}
          {% endwith %}
          {% endfor %}
          {% with export_fn="exportAssessment", import_fn="importAssessment", import_ref="assessmentFile", file_label="assessment" %}
          {% include "save_load.html.j2" %}
          {% endwith %}
          {% else %}
          <p>No risks defined.</p>
          {% endif %}
        </div>
      </div>
    </main>
  </body>
</html>
