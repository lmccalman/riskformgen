<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FormGen</title>
    <link rel="stylesheet" href="styles.css" />
    <script defer src="alpine3.15.8.min.js"></script>
  </head>
  <body class="min-h-screen bg-gray-50">
    <main class="mx-auto max-w-2xl px-4 py-12">
      <h1 class="mb-8 text-3xl font-bold text-gray-900">FormGen</h1>

      <div
        x-data="{
          activeTab: '{{ sections[0].id }}',
          answers: {
            {% for q in questions %}
            '{{ q.id }}': {% if q.type == 'multiple_select' %}[]{% else %}''{% endif %}{% if not loop.last %},{% endif %}
            {% endfor %}
          },
          assessed_risks: {
            {% for risk in risks %}'{{ risk.id }}': ''{% if not loop.last %},{% endif %}
            {% endfor %}
          },
          justifications: {
            {% for risk in risks %}'{{ risk.id }}': ''{% if not loop.last %},{% endif %}
            {% endfor %}
          },
          _levels: { not_applicable: 0, low: 1, medium: 2, high: 3 },
          _formatAnswer(val) {
            if (Array.isArray(val)) return val.length ? val.join(', ') : 'Not answered';
            return val || 'Not answered';
          },
          {% for risk in risks %}
          get {{ risk.id }}() {
            const results = [
              {% for js in risk.rules_js %}
              ({{ js }}),
              {% endfor %}
            ].filter(r => r !== null);
            if (results.length === 0) return '{{ risk.default_level }}';
            return results.reduce((w, r) => this._levels[r] > this._levels[w] ? r : w);
          },
          {% endfor %}
        }"
      >
        {# ── Tab navigation ── #}
        <div class="mb-6 flex border-b border-gray-200">
          {% for section in sections %}
          <button
            type="button"
            @click="activeTab = '{{ section.id }}'"
            :class="activeTab === '{{ section.id }}'
              ? 'border-indigo-500 text-indigo-600'
              : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700'"
            class="border-b-2 px-4 py-2 text-sm font-medium transition-colors"
          >
            {{ section.title }}
          </button>
          {% endfor %}
          <button
            type="button"
            @click="activeTab = 'risks'"
            :class="activeTab === 'risks'
              ? 'border-red-500 text-red-600'
              : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700'"
            class="ml-auto border-b-2 px-4 py-2 text-sm font-medium transition-colors"
          >
            Risk Analysis
          </button>
        </div>

        {# ── Section tabs ── #}
        {% for section in sections %}
        <form x-show="activeTab === '{{ section.id }}'" class="space-y-8">
          <p class="text-sm text-gray-500">{{ section.description }}</p>
          {% for subsection in section.subsections %}
          {% with subsection=subsection %}
          {% include "subsection.html.j2" %}
          {% endwith %}
          {% endfor %}
        </form>
        {% endfor %}

        {# ── Debug panel (visible on all section tabs) ── #}
        <div x-show="activeTab !== 'risks'" class="mt-8 rounded-lg border border-gray-200 bg-gray-800 p-6 shadow-sm space-y-4">
          <div>
            <h2 class="mb-3 text-sm font-semibold uppercase tracking-wide text-gray-400">
              Debug — Current Answers
            </h2>
            <pre
              class="text-sm text-green-400"
              x-text="JSON.stringify(answers, null, 2)"
            ></pre>
          </div>
          {% if risks %}
          <div>
            <h2 class="mb-3 text-sm font-semibold uppercase tracking-wide text-gray-400">
              Debug — Risk Levels
            </h2>
            <pre
              class="text-sm text-green-400"
              x-text="JSON.stringify({
                {% for risk in risks %}
                '{{ risk.id }}': {{ risk.id }}{% if not loop.last %},{% endif %}
                {% endfor %}
              }, null, 2)"
            ></pre>
          </div>
          <div>
            <h2 class="mb-3 text-sm font-semibold uppercase tracking-wide text-gray-400">
              Debug — Assessed Risks
            </h2>
            <pre
              class="text-sm text-green-400"
              x-text="JSON.stringify(assessed_risks, null, 2)"
            ></pre>
          </div>
          <div>
            <h2 class="mb-3 text-sm font-semibold uppercase tracking-wide text-gray-400">
              Debug — Justifications
            </h2>
            <pre
              class="text-sm text-green-400"
              x-text="JSON.stringify(justifications, null, 2)"
            ></pre>
          </div>
          {% endif %}
        </div>

        {# ── Risks tab ── #}
        <div x-show="activeTab === 'risks'" class="space-y-4">
          {% if risks %}
          {% for risk in risks %}
          {% with risk=risk %}
          {% include "risk_summary.html.j2" %}
          {% endwith %}
          {% endfor %}
          {% else %}
          <p class="text-gray-500">No risks defined.</p>
          {% endif %}
        </div>
      </div>
    </main>
  </body>
</html>
